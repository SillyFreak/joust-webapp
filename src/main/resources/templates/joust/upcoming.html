<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout">
<head>
    <title th:text="#{upcoming.name}">Upcoming games</title>
</head>
<body onload="disconnect(); connect();">
    <article layout:fragment="content">
        <table class="table">
            <tbody>
                <tr>
                    <th th:text="#{upcoming.table}">Table</th>
                    <th th:text="#{upcoming.status}">Status</th>
                    <th th:text="#{upcoming.slot}">Slot Description</th>
                </tr>
                <tr th:each="slot : ${upcoming}" th:object="${slot}"
                    th:class="#{upcoming.status.__*{state}__.class}">
                    <td th:text="*{table == null? '' : table.description}">Table 1</td>
                    <td th:text="#{upcoming.status.__*{state}__}">Table 1</td>
                    <td th:text="*{description}">Open practice for team 15-0000 TGM</td>
                </tr>
            </tbody>
        </table>
        <button id="soundButton" onclick="sendTest();">Play</button>  
        <div id="sound"></div>
        <script type="text/javascript">
var stompClient = null;

function setConnected(connected) {
    document.getElementById('soundButton').disabled = !connected;
}

function connect() {
    var socket = new SockJS('/test');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function(frame) {
        setConnected(true);
        stompClient.subscribe('/topic/slots', function(slot) {
        	slot = JSON.parse(slot.body);
            console.log('Slot: ' + slot.teamId);
        	playSound('bing');
        });
    });
}

function disconnect() {
    if (stompClient != null) {
        stompClient.disconnect();
        stompClient = null;
    }
    setConnected(false);
}

function sendTest() {
    stompClient.send("/app/test", {}, JSON.stringify({}));
}

// @param filename The name of the file WITHOUT ending
function playSound(filename) {
    document.getElementById("sound").innerHTML =
        '<audio autoplay="autoplay">'
      + '    <source src="' + filename + '.mp3" type="audio/mpeg" />'
      + '    <source src="' + filename + '.ogg" type="audio/ogg" />'
      + '    <embed hidden="true" autostart="true" loop="false" src="' + filename +'.mp3" />'
      + '</audio>';
}
        </script>
    </article>
</body>
</html>
